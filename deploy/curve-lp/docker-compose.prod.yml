version: '3.8'

services:
  # Creates dummy cert if none exists, so nginx can start
  certbot-init:
    image: certbot/certbot
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    environment:
      - DOMAIN=${DOMAIN}
    entrypoint: /bin/sh
    command: >
      -c '
        if [ ! -d /etc/letsencrypt/live/$$DOMAIN ]; then
          echo "Creating dummy certificate for nginx to start...";
          mkdir -p /etc/letsencrypt/live/$$DOMAIN;
          openssl req -x509 -nodes -days 1 -newkey rsa:2048 \
            -keyout /etc/letsencrypt/live/$$DOMAIN/privkey.pem \
            -out /etc/letsencrypt/live/$$DOMAIN/fullchain.pem \
            -subj "/CN=localhost";
        fi
      '

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.template:ro
      - certbot-etc:/etc/letsencrypt:ro
      - certbot-www:/var/www/certbot
    environment:
      - DOMAIN=${DOMAIN}
    depends_on:
      certbot-init:
        condition: service_completed_successfully
      driver-shadow:
        condition: service_started
      driver-staging:
        condition: service_started
      driver-prod:
        condition: service_started
    restart: unless-stopped
    entrypoint: /bin/sh
    command: >
      -c '
        sed "s/\$$DOMAIN/$$DOMAIN/g" /etc/nginx/nginx.template > /etc/nginx/nginx.conf;
        exec nginx -g "daemon off;"
      '
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Gets real cert and handles renewals
  certbot:
    image: certbot/certbot
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-www:/var/www/certbot
    environment:
      - DOMAIN=${DOMAIN}
      - SSL_EMAIL=${SSL_EMAIL}
    entrypoint: /bin/sh
    command: >
      -c '
        # Wait for nginx to be ready
        echo "Waiting for nginx...";
        sleep 10;

        # Check if we have a real cert (not self-signed)
        if [ ! -f /etc/letsencrypt/renewal/$$DOMAIN.conf ]; then
          echo "Getting real certificate from Lets Encrypt...";
          certbot certonly --webroot --webroot-path=/var/www/certbot \
            --email $$SSL_EMAIL --agree-tos --no-eff-email \
            --force-renewal -d $$DOMAIN;
          if [ $$? -eq 0 ]; then
            echo "Certificate obtained! Nginx will reload shortly.";
          fi
        else
          echo "Real certificate already exists.";
        fi;

        # Renewal loop
        echo "Starting renewal loop...";
        while :; do
          sleep 12h;
          echo "Checking for renewal...";
          certbot renew --webroot --webroot-path=/var/www/certbot;
        done
      '
    depends_on:
      - nginx
    restart: unless-stopped

  driver-shadow:
    image: ghcr.io/cowprotocol/services:latest
    command:
      - driver
      - --config
      - /config/driver.toml
      - --ethrpc
      - ${NODE_URL}
      - --addr
      - 0.0.0.0:11088
    ports:
      - "127.0.0.1:11088:11088"
    volumes:
      - ./processed/driver-shadow.toml:/config/driver.toml:ro
    environment:
      - NODE_URL=${NODE_URL}
    depends_on:
      - solver
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  driver-staging:
    image: ghcr.io/cowprotocol/services:latest
    command:
      - driver
      - --config
      - /config/driver.toml
      - --ethrpc
      - ${NODE_URL}
      - --addr
      - 0.0.0.0:11089
    ports:
      - "127.0.0.1:11089:11089"
    volumes:
      - ./processed/driver-staging.toml:/config/driver.toml:ro
    environment:
      - NODE_URL=${NODE_URL}
    depends_on:
      - solver
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  driver-prod:
    image: ghcr.io/cowprotocol/services:latest
    command:
      - driver
      - --config
      - /config/driver.toml
      - --ethrpc
      - ${NODE_URL}
      - --addr
      - 0.0.0.0:11090
    ports:
      - "127.0.0.1:11090:11090"
    volumes:
      - ./processed/driver-prod.toml:/config/driver.toml:ro
    environment:
      - NODE_URL=${NODE_URL}
    depends_on:
      - solver
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  solver:
    build:
      context: ../..
      dockerfile: Dockerfile
      target: solvers
    command: >
      --addr 0.0.0.0:7872
      curvelp
      --config /config/curve-lp.toml
    expose:
      - "7872"
    volumes:
      - ./processed/curve-lp.toml:/config/curve-lp.toml:ro
    environment:
      - NODE_URL=${NODE_URL}
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

volumes:
  certbot-etc:
  certbot-www:
